# deploy

This is a Makefile-based deployment system for syncing git repositories across several web hosts.

For those who haven't graduated to [GitHub Actions](https://docs.github.com/en/actions) or [Bitbucket Pipelines](https://bitbucket.org/product/features/pipelines) or another continuous delivery solution, I offer this. You can run it in any directory at any time for any server under your stewardship.

[Phony targets](https://www.gnu.org/software/make/manual/html_node/Phony-Targets.html) have probably never been so abused.

## prerequisites

+ [GNU make](https://www.gnu.org/software/make/).
+ [Python 3](https://www.python.org).
+ SSH public-key authentication on the remote hosts.
+ SSH aliases in `~/.ssh/config`. These correspond to the "remote_host" column in `websites.tsv` (see below); this is not to be confused with the "alias" column.
+ Plugins need to be named with a "-plugin" suffix (e.g., "foo-plugin").
+ Themes need to be named with a "-theme" suffix (e.g., "bar-theme").
+ The `wp` command must be installed on the remote host. [Download it from wp-cli.org.](https://wp-cli.org)
+ Both domain and subdomain folders need to be located in the home directory on the remote server. If they are not (Bluehost places subdomains in a subfolder of `~/public_html`), create symbolic links:

```shell
remote-host $ ln -s ~/public_html/dev.server.org ~/dev.server.org
```

## installation

Download or clone the repository some place nice, like `~/bin/deploy`. I made an alias to make execution more convenient and to make a command named `deploy` available anywhere:

```shell
$ echo "alias deploy='make -f ~/bin/deploy/Makefile'" >> ~/.zshrc
$ source ~/.zshrc
```

### configuration

+ Check out the variables at the top of the `Makefile`. In particular, you may wish to edit `GIT_BRANCH` and `FLYWHEEL_PATH_PREFIX` (the remote folder path used for rsync).
+ Edit `excluded.txt` for path names and patterns that rsync should not copy to the remote server.

### populating the tsv file

Create a file named `websites.tsv` with the following fields separated by tabs:

| domain | remote_host | subfolder | subdomains | function | dependencies | alias | webhost | client |
|--------|-------------|-----------|------------|----------|--------------|-------|---------|--------|
| whatever.org | ssh_alias | whatever.org | dev, staging | git | foo-plugin, bar-theme | what | dreamhost | bzmn |

+ Multiple subdomains and multiple dependencies are separated by commas.
+ For rsync workflows, the "subfolder" column value is the local path relative to the `LOCAL_PATH_PREFIX` variable in the `Makefile`. The remote subfolder is assumed to be the `FLYWHEEL_PATH_PREFIX` as defined in the `Makefile`.
+ Add a comment by prepending a "#" sign to the beginning of the line.

**Tip:** I use a spreadsheet program to edit this file.

## usage

```shell
$ deploy whatever.org
```

or, with the alias:

```shell
$ deploy what
```

Either command updates `foo-plugin` and `foo-theme` for `whatever.org`, `dev.whatever.org`, and `staging.whatever.org` via git. In total, six repositories will be synced with a single command. Additional targets let you update just the plugin or just the theme.

## overview

There are three syncing mechanisms:

1. [git](https://git-scm.com). The command `git pull` is executed on a given branch in a folder on a remote server.
1. [rsync](https://rsync.samba.org). A local folder is synced with a folder on a remote server. Only newer files are copied.
1. [wp cli](https://wp-cli.org). A `wp plugin update` or `wp theme update` command is executed on a WordPress instance (folder / path) on a remote server. This requires `wp` to be installed on the remote server.

In all of the above cases, SSH keys are configured on the remote host and SSH aliases are configured in `~/.ssh/config`.

## features

Via a single command, you may...

+ Update all custom plugins and themes on a website and its subdomains: `deploy what`.
+ Update all custom plugins and themes for a given client (on multiple websites): `deploy bzmn`.
+ Update all custom plugins and themes for a given web host (for multiple clients): `deploy bzmn client2 client3`.
+ Update all custom plugins and themes on all websites for all clients: `deploy all`.

More specific targets are defined in `targets.makefile`. (Note: this file is automatically generated and does not exist until the program is run once. It is re-generated on every program execution.)

### local targets

If you're familiar with make's syntax, you can add local targets in any directory by dropping them into `./targets.makefile`.

## misc

There's some code to make exceptions for [my own plugin](https://github.com/baizmandesign/baizman-design-standard-library-wp-plugin). This code can be ignored or removed.